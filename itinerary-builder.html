<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Itinerary Builder - YOUR LOCALS</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: #f4f7f6; color: #333; height: 100vh; display: flex; flex-direction: column; }
        .main-builder-container { display: flex; flex: 1; overflow: hidden; }

        /* --- 3パネル共通 --- */
        .panel { padding: 20px; background-color: #fff; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .panel-title { margin-top: 0; font-size: 1.5em; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .scrollable-content { overflow-y: auto; height: calc(100% - 60px); }

        /* --- 左パネル: 旅程ボックス --- */
        #itinerary-panel { flex-basis: 350px; display: flex; flex-direction: column; }
        .time-setter { display: flex; gap: 10px; margin-bottom: 15px; }
        .time-setter input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
        .timeline-wrapper { position: relative; flex: 1; overflow-y: auto; }
        #timeline-grid {
            position: relative; /* ドラッグアイテムの基準 */
            background-size: 100% 40px; /* 1時間 = 40px */
            background-image: linear-gradient(to bottom, #e9ecef 1px, transparent 1px);
        }
        .time-marker { position: absolute; left: -50px; width: 40px; text-align: right; color: #888; font-size: 0.8em; }
        .itinerary-item {
            position: absolute;
            left: 5px; right: 5px;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            color: white;
            overflow: hidden;
            box-sizing: border-box;
        }
        .itinerary-item.stay { background-color: #28a745; }
        .itinerary-item.travel { background-color: #6c757d; }

        /* --- 中央パネル: 場所まとめ --- */
        #places-panel { flex: 1; display: flex; flex-direction: column; border-left: 1px solid #ddd; border-right: 1px solid #ddd; }
        .genre-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .genre-btn, .fav-toggle-btn { padding: 10px; border: 1px solid #ccc; background-color: #f8f9fa; border-radius: 5px; cursor: pointer; text-align: center; }
        .genre-btn.active { background-color: #007bff; color: white; }
        .place-list-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; cursor: grab; }
        .place-list-item:active { cursor: grabbing; }
        .fav-btn { cursor: pointer; font-size: 1.5em; color: #ccc; }
        .fav-btn.favorited { color: #ff4757; }

        /* --- 右パネル: 地図 --- */
        #map-panel { flex-basis: 400px; display: flex; flex-direction: column; }
        #map-placeholder { flex: 1; background: #e0e0e0 url(https://i.imgur.com/2YQY8qP.png) center/contain no-repeat; border-radius: 8px; position: relative; }
        .map-pin { position: absolute; width: 20px; height: 20px; background: #dc3545; border-radius: 50%; border: 2px solid white; transform: translate(-50%, -50%); }
        .map-pin.highlight { background: #ffc107; transform: translate(-50%, -50%) scale(1.5); }
        
        /* --- ポップアップ/モーダル --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; max-width: 500px; }
    </style>
</head>
<body>

    <main class="main-builder-container">
        <section id="itinerary-panel" class="panel">
            <h2 class="panel-title">Your Itinerary</h2>
            <div class="time-setter">
                <input type="time" id="start-time" value="09:00">
                <input type="time" id="end-time" value="18:00">
            </div>
            <div class="timeline-wrapper">
                <div id="timeline-grid"></div>
            </div>
        </section>

        <section id="places-panel" class="panel">
            <h2 class="panel-title">Find Places</h2>
            <div class="genre-list"></div>
            <button class="fav-toggle-btn">Show Favorites ❤️</button>
            <div class="scrollable-content" id="place-list"></div>
        </section>

        <section id="map-panel" class="panel">
            <h2 class="panel-title">Map</h2>
            <div id="map-placeholder"></div>
        </section>
    </main>

    <div id="start-station-modal" class="modal-overlay visible">
        <div class="modal-content">
            <h3>Where are you starting from?</h3>
            <p>Please select your starting station.</p>
            <div class="genre-list" id="station-selection-buttons"></div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- データ（仮） ---
        const DUMMY_DATA = {
            places: [
                { id: 1, name: "Dotonbori Glico Sign", genre: "sightseeing", station: "namba", stay: 30, desc: "A famous landmark in Osaka. Great for photos!", photo: "https://i.imgur.com/GplnmUI.jpeg" },
                { id: 2, name: "Kuromon Market", genre: "food", station: "namba", stay: 90, desc: "Known as 'Osaka's Kitchen'. Enjoy fresh seafood and local snacks.", photo: "https://i.imgur.com/bK16H8S.png" },
                { id: 3, name: "Osaka Castle", genre: "history", station: "osaka", stay: 120, desc: "A beautiful and historic castle with a museum inside.", photo: "https://i.imgur.com/8QWBHqf.png" },
                { id: 4, name: "Shitennoji Temple", genre: "history", station: "tennoji", stay: 60, desc: "One of Japan's oldest temples, offering a peaceful atmosphere.", photo: "https://i.imgur.com/V98wG3J.png" },
                { id: 5, name: "Umeda Sky Building", genre: "sightseeing", station: "osaka", stay: 75, desc: "Offers a stunning 360-degree view of the city from its floating garden observatory.", photo: "https://i.imgur.com/bK16H8S.png" }
            ],
            genres: ["sightseeing", "food", "history", "shopping"],
            stations: {
                "osaka": { name: "Osaka/Umeda Station", mapPos: { top: "30%", left: "40%" } },
                "namba": { name: "Namba Station", mapPos: { top: "60%", left: "50%" } },
                "tennoji": { name: "Tennoji Station", mapPos: { top: "80%", left: "65%" } }
            },
            travelTimes: { "osaka-namba": 15, "namba-tennoji": 10, "tennoji-osaka": 20 }
        };

        // --- DOM要素 ---
        const itineraryPanel = document.getElementById("itinerary-panel");
        const timelineGrid = document.getElementById("timeline-grid");
        const placesPanel = document.getElementById("places-panel");
        const genreList = document.querySelector(".genre-list");
        const placeList = document.getElementById("place-list");
        const favToggleButton = document.querySelector(".fav-toggle-btn");
        const stationModal = document.getElementById("start-station-modal");
        const stationSelectionButtons = document.getElementById("station-selection-buttons");
        
        let state = {
            startStation: null,
            favorites: [],
            itinerary: [],
            startTime: 9 * 60,
            endTime: 18 * 60,
            currentFilter: { type: 'genre', value: null }
        };

        // --- Functions ---
        const renderStationSelection = () => {
            Object.keys(DUMMY_DATA.stations).forEach(key => {
                const btn = document.createElement("button");
                btn.className = "genre-btn";
                btn.textContent = DUMMY_DATA.stations[key].name;
                btn.onclick = () => selectStartStation(key);
                stationSelectionButtons.appendChild(btn);
            });
        };

        const selectStartStation = (stationKey) => {
            state.startStation = stationKey;
            stationModal.classList.remove("visible");
            renderGenres();
            renderPlaces();
        };

        const renderGenres = () => {
            genreList.innerHTML = '';
            DUMMY_DATA.genres.forEach(genre => {
                const btn = document.createElement("button");
                btn.className = "genre-btn";
                btn.textContent = genre;
                btn.onclick = () => {
                    state.currentFilter = { type: 'genre', value: genre };
                    renderPlaces();
                };
                genreList.appendChild(btn);
            });
        };
        
        const renderPlaces = () => {
            placeList.innerHTML = '';
            let placesToRender = [];
            if (state.currentFilter.type === 'favorites') {
                placesToRender = DUMMY_DATA.places.filter(p => state.favorites.includes(p.id));
            } else if (state.currentFilter.type === 'genre' && state.currentFilter.value) {
                placesToRender = DUMMY_DATA.places.filter(p => p.genre === state.currentFilter.value);
            } else {
                placesToRender = DUMMY_DATA.places;
            }
            
            placesToRender.forEach(place => {
                const item = document.createElement("div");
                item.className = "place-list-item";
                item.draggable = true;
                item.dataset.placeId = place.id;
                item.ondragstart = (e) => e.dataTransfer.setData("text/plain", place.id);

                const name = document.createElement("span");
                name.textContent = place.name;
                
                const favBtn = document.createElement("span");
                favBtn.className = "fav-btn";
                favBtn.innerHTML = "❤️";
                if(state.favorites.includes(place.id)) favBtn.classList.add("favorited");
                favBtn.onclick = (e) => {
                    e.stopPropagation();
                    toggleFavorite(place.id);
                };
                
                item.appendChild(name);
                item.appendChild(favBtn);
                placeList.appendChild(item);
            });
        };
        
        const toggleFavorite = (placeId) => {
            const index = state.favorites.indexOf(placeId);
            if (index > -1) state.favorites.splice(index, 1);
            else state.favorites.push(placeId);
            renderPlaces(); // Re-render to update heart icon
        };

        const renderItinerary = () => {
            timelineGrid.innerHTML = '';
            const totalMinutes = state.endTime - state.startTime;
            const hourHeight = 80; // 1時間あたりのピクセル高さ
            timelineGrid.style.height = `${(totalMinutes / 60) * hourHeight}px`;

            // 時間メモリを生成 (15分刻み)
            for(let i = 0; i <= totalMinutes; i += 60) {
                 const timeMarker = document.createElement('div');
                 timeMarker.className = 'time-marker';
                 timeMarker.textContent = `${(state.startTime + i) / 60}:00`;
                 timeMarker.style.top = `${(i / 60) * hourHeight - 10}px`;
                 timelineGrid.appendChild(timeMarker);
            }
            
            let currentTime = state.startTime;
            state.itinerary.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = `itinerary-item ${item.type}`;
                itemEl.textContent = item.name || `${item.duration} min travel`;
                itemEl.style.top = `${((currentTime - state.startTime) / 60) * hourHeight}px`;
                itemEl.style.height = `${(item.duration / 60) * hourHeight}px`;
                timelineGrid.appendChild(itemEl);
                currentTime += item.duration;
            });
        };

        // --- Event Listeners ---
        favToggleButton.onclick = () => {
            state.currentFilter = { type: 'favorites' };
            renderPlaces();
        };
        
        itineraryPanel.ondragover = (e) => e.preventDefault();
        itineraryPanel.ondrop = (e) => {
            e.preventDefault();
            const placeId = parseInt(e.dataTransfer.getData("text/plain"));
            const place = DUMMY_DATA.places.find(p => p.id === placeId);
            
            if(place) {
                // 移動時間を追加
                if(state.itinerary.length > 0){
                    const lastPlace = DUMMY_DATA.places.find(p => p.id === state.itinerary[state.itinerary.length - 1].id);
                    const travelKey = `${lastPlace.station}-${place.station}`;
                    const revTravelKey = `${place.station}-${lastPlace.station}`;
                    const travelTime = DUMMY_DATA.travelTimes[travelKey] || DUMMY_DATA.travelTimes[revTravelKey] || 15;
                    state.itinerary.push({ id: `travel-${Date.now()}`, type: 'travel', duration: travelTime });
                }
                state.itinerary.push({ ...place, type: 'stay' });
                renderItinerary();
            }
        };
        
        document.getElementById('start-time').onchange = (e) => {
            const [h, m] = e.target.value.split(':');
            state.startTime = parseInt(h) * 60 + parseInt(m);
            renderItinerary();
        };
        document.getElementById('end-time').onchange = (e) => {
            const [h, m] = e.target.value.split(':');
            state.endTime = parseInt(h) * 60 + parseInt(m);
            renderItinerary();
        };
        
        // --- 初期化 ---
        renderStationSelection();
        renderItinerary();
    });
    </script>
</body>
</html>
